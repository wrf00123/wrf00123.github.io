<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片压缩工具 - 增强版</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind自定义主题 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4E5BA6',
                        secondary: '#F2C94C',
                        neutral: '#F5F7FA',
                        dark: '#333333',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.02)',
                        'hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    }
                },
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .transition-custom {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .gradient-bg {
                background: linear-gradient(135deg, #4E5BA6 0%, #6B7FD7 100%);
            }
            .image-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 1rem;
            }
            .format-btn-active {
                @apply border-primary bg-primary/5 text-primary font-medium;
            }
        }
    </style>
</head>
<body class="bg-neutral min-h-screen font-sans text-dark">
    <!-- 页面容器 -->
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- 头部 -->
        <header class="text-center mb-12">
            <div class="inline-flex items-center justify-center mb-4 p-3 rounded-full bg-primary/10">
                <i class="fa fa-compress text-primary text-2xl"></i>
            </div>
            <h1 class="text-[clamp(1.8rem,5vw,2.5rem)] font-bold text-primary mb-2">图片压缩工具</h1>
            <p class="text-gray-600 max-w-2xl mx-auto">增强压缩强度，支持深度压缩，可显著减小文件体积</p>
        </header>
        
        <!-- 主内容区 -->
        <main class="grid md:grid-cols-3 gap-8">
            <!-- 左侧：上传和原图预览列表 -->
            <div class="md:col-span-2 bg-white rounded-2xl shadow-card p-6 transition-custom hover:shadow-hover">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-cloud-upload text-primary mr-2"></i>上传图片
                    <span id="image-count" class="ml-2 text-sm bg-primary/10 text-primary px-2 py-0.5 rounded-full">0张图片</span>
                </h2>
                
                <!-- 上传区域 -->
                <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer transition-custom hover:border-primary hover:bg-primary/5 mb-6">
                    <i class="fa fa-image text-4xl text-gray-400 mb-3"></i>
                    <p class="text-gray-500 mb-2">点击或拖拽图片到此处</p>
                    <p class="text-gray-400 text-sm">支持 JPG、PNG、WebP、GIF 等格式，可批量上传</p>
                    <input type="file" id="file-input" class="hidden" accept="image/*" multiple>
                </div>
                
                <!-- 原图预览列表 -->
                <div id="images-container" class="hidden">
                    <h3 class="font-medium text-gray-700 mb-3">已选择图片</h3>
                    <div id="original-previews" class="image-grid mb-4">
                        <!-- 图片预览项会动态添加到这里 -->
                    </div>
                    
                    <!-- 批量操作按钮 -->
                    <div class="flex gap-3">
                        <button id="compress-all-btn" class="flex-1 py-3 gradient-bg text-white rounded-lg font-medium transition-custom hover:opacity-90 transform hover:-translate-y-1 disabled:opacity-50 disabled:pointer-events-none disabled:hover:translate-y-0" disabled>
                            <i class="fa fa-magic mr-2"></i>全部压缩
                        </button>
                        <button id="clear-all-btn" class="px-4 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium transition-custom hover:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none">
                            <i class="fa fa-trash mr-1"></i>清空
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：压缩设置和结果预览 -->
            <div class="bg-white rounded-2xl shadow-card p-6 transition-custom hover:shadow-hover">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fa fa-sliders text-primary mr-2"></i>压缩设置
                </h2>
                
                <!-- 压缩设置 -->
                <div id="compression-settings" class="mb-6 opacity-50 pointer-events-none">
                    <!-- 压缩强度 -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">压缩强度</label>
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            <button class="compression-strength-btn py-2 px-3 rounded-lg border border-gray-200 text-sm hover:border-primary hover:bg-primary/5 transition-custom" data-strength="low">轻度</button>
                            <button class="compression-strength-btn py-2 px-3 rounded-lg border border-gray-200 text-sm hover:border-primary hover:bg-primary/5 transition-custom format-btn-active" data-strength="medium">中度</button>
                            <button class="compression-strength-btn py-2 px-3 rounded-lg border border-gray-200 text-sm hover:border-primary hover:bg-primary/5 transition-custom" data-strength="high">深度</button>
                        </div>
                        <div class="text-xs text-gray-500">
                            <i class="fa fa-info-circle mr-1"></i> 深度压缩可获得更小体积，但可能影响图片质量
                        </div>
                    </div>
                    
                    <!-- 质量调节 - 扩大范围 -->
                    <div class="mb-6">
                        <label for="quality-slider" class="block text-sm font-medium text-gray-700 mb-2">压缩质量 (1-100)</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="quality-slider" min="1" max="100" value="60" 
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                            <span id="quality-value" class="text-primary font-medium min-w-[40px] text-center">60%</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-1">
                            <span>体积更小</span>
                            <span>质量更高</span>
                        </div>
                        <div class="text-xs text-amber-600 mt-2 bg-amber-50 p-2 rounded hidden" id="png-quality-note">
                            <i class="fa fa-info-circle mr-1"></i> PNG格式压缩质量建议设置在30-70%之间
                        </div>
                    </div>
                    
                    <!-- 尺寸调整 -->
                    <div class="mb-6">
                        <label for="resize-percentage" class="block text-sm font-medium text-gray-700 mb-2">尺寸调整 (%)</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="resize-percentage" min="10" max="100" value="100" 
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-primary">
                            <span id="resize-value" class="text-primary font-medium min-w-[40px] text-center">100%</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            <i class="fa fa-info-circle mr-1"></i> 降低尺寸可显著减小文件体积
                        </div>
                    </div>
                    
                    <!-- 格式选择 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">导出格式</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button class="format-btn py-2 px-3 rounded-lg border border-gray-200 text-sm hover:border-primary hover:bg-primary/5 transition-custom format-btn-active" data-format="jpeg">JPEG</button>
                            <button class="format-btn py-2 px-3 rounded-lg border border-gray-200 text-sm hover:border-primary hover:bg-primary/5 transition-custom" data-format="png">PNG</button>
                            <button class="format-btn py-2 px-3 rounded-lg border border-gray-200 text-sm hover:border-primary hover:bg-primary/5 transition-custom" data-format="webp">WebP</button>
                        </div>
                        <div class="text-xs text-blue-600 mt-2 bg-blue-50 p-2 rounded">
                            <i class="fa fa-lightbulb-o mr-1"></i> WebP格式通常能提供最佳的压缩效果
                        </div>
                    </div>
                    
                    <!-- PNG特定优化选项 -->
                    <div class="mt-4 hidden" id="png-optimization-options">
                        <label class="block text-sm font-medium text-gray-700 mb-2">PNG优化</label>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="png-reduce-colors" class="rounded text-primary focus:ring-primary" checked>
                            <label for="png-reduce-colors" class="text-sm text-gray-700">减少颜色数量</label>
                        </div>
                        <div class="flex items-center space-x-2 mt-2">
                            <input type="checkbox" id="png-remove-metadata" class="rounded text-primary focus:ring-primary" checked>
                            <label for="png-remove-metadata" class="text-sm text-gray-700">移除元数据</label>
                        </div>
                        <div class="flex items-center space-x-2 mt-2">
                            <input type="checkbox" id="png-convert-to-8bit" class="rounded text-primary focus:ring-primary">
                            <label for="png-convert-to-8bit" class="text-sm text-gray-700">转为8位PNG (更小体积)</label>
                        </div>
                    </div>
                    
                    <!-- JPEG特定优化选项 -->
                    <div class="mt-4 hidden" id="jpeg-optimization-options">
                        <label class="block text-sm font-medium text-gray-700 mb-2">JPEG优化</label>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="jpeg-optimize" class="rounded text-primary focus:ring-primary" checked>
                            <label for="jpeg-optimize" class="text-sm text-gray-700">启用高级压缩</label>
                        </div>
                        <div class="flex items-center space-x-2 mt-2">
                            <input type="checkbox" id="jpeg-grayscale" class="rounded text-primary focus:ring-primary">
                            <label for="jpeg-grayscale" class="text-sm text-gray-700">转为灰度图 (更小体积)</label>
                        </div>
                    </div>
                </div>
                
                <!-- 当前处理图片信息 -->
                <div id="current-image-info" class="mb-6 hidden">
                    <div class="text-sm text-gray-600 mb-2">当前处理:</div>
                    <div class="bg-gray-50 rounded-lg p-3 text-sm">
                        <div id="current-image-name" class="truncate"></div>
                    </div>
                </div>
                
                <!-- 压缩进度 -->
                <div id="compression-progress" class="mb-6 hidden">
                    <div class="text-sm text-gray-600 mb-2">压缩进度:</div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span id="progress-text">0/0</span>
                        <span id="progress-percentage">0%</span>
                    </div>
                </div>
                
                <!-- 结果预览 -->
                <div id="result-preview" class="hidden">
                    <h3 class="font-medium text-gray-700 mb-2">压缩结果</h3>
                    <div class="relative rounded-lg overflow-hidden bg-gray-100 mb-3">
                        <img id="compressed-image" class="w-full h-auto max-h-48 object-contain" alt="压缩后图片预览">
                    </div>
                    <div class="flex justify-between text-sm text-gray-600 mb-4">
                        <span id="original-size" class="text-gray-500 line-through">原图: --</span>
                        <span id="compressed-size" class="text-primary">压缩后: --</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600 mb-4">
                        <span id="compressed-dimensions">尺寸: --</span>
                        <span id="savings" class="text-green-600 font-medium">节省: --</span>
                    </div>
                    
                    <!-- 压缩信息 -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                        <div class="flex items-center text-green-700 text-sm">
                            <i class="fa fa-check-circle mr-2"></i>
                            <span>压缩完成</span>
                        </div>
                    </div>
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4 hidden" id="size-warning">
                        <div class="flex items-center text-amber-700 text-sm">
                            <i class="fa fa-exclamation-circle mr-2"></i>
                            <span>注意：压缩后文件变大，建议尝试更低质量或不同格式</span>
                        </div>
                    </div>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4 hidden" id="error-warning">
                        <div class="flex items-center text-red-700 text-sm">
                            <i class="fa fa-times-circle mr-2"></i>
                            <span>图片处理出错，请尝试重新压缩</span>
                        </div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 hidden" id="console-log">
                        <div class="flex items-center text-blue-700 text-sm">
                            <i class="fa fa-info-circle mr-2"></i>
                            <span id="console-message"></span>
                        </div>
                    </div>
                    
                    <!-- 下载按钮 -->
                    <button id="download-all-btn" class="w-full py-3 bg-primary text-white rounded-lg font-medium transition-custom hover:bg-primary/90 transform hover:-translate-y-1 mb-3">
                        <i class="fa fa-download mr-2"></i>下载全部
                    </button>
                    <button id="download-current-btn" class="w-full py-3 border border-primary text-primary rounded-lg font-medium transition-custom hover:bg-primary/5">
                        <i class="fa fa-file-image-o mr-2"></i>下载当前图片
                    
                    </button>
                </div>
            </div>
        </main>
        
        <!-- 功能特点 -->
        <section class="mt-16">
            <h2 class="text-2xl font-bold text-center mb-10">强大的压缩能力</h2>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-card text-center transition-custom hover:shadow-hover">
                    <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa fa-compress text-primary text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-lg mb-2">深度压缩算法</h3>
                    <p class="text-gray-600">采用增强压缩算法，可比普通压缩多减少50%以上的文件体积</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-card text-center transition-custom hover:shadow-hover">
                    <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa fa-sliders text-primary text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-lg mb-2">多维度调节</h3>
                    <p class="text-gray-600">通过质量、尺寸和格式多维度调节，实现最佳压缩效果</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-card text-center transition-custom hover:shadow-hover">
                    <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa fa-balance-scale text-primary text-xl"></i>
                    </div>
                    <h3 class="font-semibold text-lg mb-2">质量体积平衡</h3>
                    <p class="text-gray-600">智能算法在减小体积的同时，尽可能保持图片的视觉质量</p>
                </div>
            </div>
        </section>
        
        <!-- 页脚 -->
        <footer class="mt-16 text-center text-gray-500 text-sm">
            <p>© 2023 图片压缩工具 - 增强版提供更强的压缩能力</p>
        </footer>
    </div>
    
    <!-- 加载中弹窗 -->
    <div id="loading-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl flex flex-col items-center max-w-xs w-full">
            <div class="w-16 h-16 border-4 border-primary/20 border-t-primary rounded-full animate-spin mb-4"></div>
            <p class="text-gray-700 font-medium">正在压缩图片...</p>
        </div>
    </div>

    <script>
        // 确保DOM完全加载后再执行
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            const imagesContainer = document.getElementById('images-container');
            const originalPreviews = document.getElementById('original-previews');
            const imageCount = document.getElementById('image-count');
            const compressAllBtn = document.getElementById('compress-all-btn');
            const clearAllBtn = document.getElementById('clear-all-btn');
            const compressionSettings = document.getElementById('compression-settings');
            const qualitySlider = document.getElementById('quality-slider');
            const qualityValue = document.getElementById('quality-value');
            const resizePercentage = document.getElementById('resize-percentage');
            const resizeValue = document.getElementById('resize-value');
            const formatBtns = document.querySelectorAll('.format-btn');
            const compressionStrengthBtns = document.querySelectorAll('.compression-strength-btn');
            const currentImageInfo = document.getElementById('current-image-info');
            const currentImageName = document.getElementById('current-image-name');
            const compressionProgress = document.getElementById('compression-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressPercentage = document.getElementById('progress-percentage');
            const resultPreview = document.getElementById('result-preview');
            const compressedImage = document.getElementById('compressed-image');
            const originalSize = document.getElementById('original-size');
            const compressedSize = document.getElementById('compressed-size');
            const compressedDimensions = document.getElementById('compressed-dimensions');
            const savings = document.getElementById('savings');
            const sizeWarning = document.getElementById('size-warning');
            const errorWarning = document.getElementById('error-warning');
            const consoleLog = document.getElementById('console-log');
            const consoleMessage = document.getElementById('console-message');
            const pngQualityNote = document.getElementById('png-quality-note');
            const pngOptimizationOptions = document.getElementById('png-optimization-options');
            const pngReduceColors = document.getElementById('png-reduce-colors');
            const pngRemoveMetadata = document.getElementById('png-remove-metadata');
            const pngConvertTo8bit = document.getElementById('png-convert-to-8bit');
            const jpegOptimizationOptions = document.getElementById('jpeg-optimization-options');
            const jpegOptimize = document.getElementById('jpeg-optimize');
            const jpegGrayscale = document.getElementById('jpeg-grayscale');
            const downloadAllBtn = document.getElementById('download-all-btn');
            const downloadCurrentBtn = document.getElementById('download-current-btn');
            const loadingModal = document.getElementById('loading-modal');
            
            // 变量初始化
            let selectedFiles = [];
            let compressedFiles = [];
            let selectedFormat = 'jpeg';
            let compressionStrength = 'medium'; // low, medium, high
            let isCompressing = false;
            
            // 显示控制台消息
            function showConsoleMessage(message) {
                consoleMessage.textContent = message;
                consoleLog.classList.remove('hidden');
                setTimeout(() => {
                    consoleLog.classList.add('hidden');
                }, 3000);
            }
            
            // 根据压缩强度自动设置质量值
            function updateQualityByStrength() {
                switch(compressionStrength) {
                    case 'low':
                        qualitySlider.value = 80;
                        break;
                    case 'medium':
                        qualitySlider.value = 60;
                        break;
                    case 'high':
                        qualitySlider.value = 40;
                        break;
                }
                qualityValue.textContent = `${qualitySlider.value}%`;
            }
            
            // 事件监听：压缩强度选择
            compressionStrengthBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    try {
                        // 移除所有按钮的选中状态
                        compressionStrengthBtns.forEach(b => {
                            b.classList.remove('format-btn-active');
                        });
                        
                        // 设置当前按钮为选中状态
                        btn.classList.add('format-btn-active');
                        compressionStrength = btn.dataset.strength;
                        
                        // 根据强度自动调整质量值
                        updateQualityByStrength();
                        
                        showConsoleMessage(`已选择${
                            compressionStrength === 'low' ? '轻度' : 
                            compressionStrength === 'medium' ? '中度' : '深度'
                        }压缩`);
                    } catch (error) {
                        console.error('压缩强度选择错误:', error);
                        showConsoleMessage('选择压缩强度时出错');
                    }
                });
            });
            
            // 事件监听：格式选择
            formatBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    try {
                        // 移除所有按钮的选中状态
                        formatBtns.forEach(b => {
                            b.classList.remove('format-btn-active');
                        });
                        
                        // 设置当前按钮为选中状态
                        btn.classList.add('format-btn-active');
                        selectedFormat = btn.dataset.format;
                        
                        // 显示/隐藏对应格式的优化选项
                        if (selectedFormat === 'png') {
                            pngQualityNote.classList.remove('hidden');
                            pngOptimizationOptions.classList.remove('hidden');
                            jpegOptimizationOptions.classList.add('hidden');
                            
                            // 调整PNG质量范围
                            if (qualitySlider.value > 70) {
                                qualitySlider.value = 70;
                                qualityValue.textContent = '70%';
                            }
                        } else if (selectedFormat === 'jpeg') {
                            pngQualityNote.classList.add('hidden');
                            pngOptimizationOptions.classList.add('hidden');
                            jpegOptimizationOptions.classList.remove('hidden');
                        } else { // webp
                            pngQualityNote.classList.add('hidden');
                            pngOptimizationOptions.classList.add('hidden');
                            jpegOptimizationOptions.classList.add('hidden');
                        }
                        
                        showConsoleMessage(`已选择${selectedFormat.toUpperCase()}格式`);
                    } catch (error) {
                        console.error('格式选择错误:', error);
                        showConsoleMessage('格式选择时出错');
                    }
                });
            });
            
            // 事件监听：上传区域点击触发文件选择
            uploadArea.addEventListener('click', () => {
                try {
                    fileInput.click();
                } catch (error) {
                    console.error('上传区域点击错误:', error);
                    showConsoleMessage('上传区域点击时出错');
                }
            });
            
            // 事件监听：文件选择变化
            fileInput.addEventListener('change', (e) => {
                try {
                    if (e.target.files && e.target.files.length > 0) {
                        handleFiles(Array.from(e.target.files));
                        showConsoleMessage(`已选择${e.target.files.length}张图片`);
                    }
                } catch (error) {
                    console.error('文件选择错误:', error);
                    showConsoleMessage('文件选择时出错');
                }
            });
            
            // 事件监听：拖放功能
            uploadArea.addEventListener('dragover', (e) => {
                try {
                    e.preventDefault();
                    uploadArea.classList.add('border-primary', 'bg-primary/10');
                } catch (error) {
                    console.error('拖放悬停错误:', error);
                }
            });
            
            uploadArea.addEventListener('dragleave', () => {
                try {
                    uploadArea.classList.remove('border-primary', 'bg-primary/10');
                } catch (error) {
                    console.error('拖放离开错误:', error);
                }
            });
            
            uploadArea.addEventListener('drop', (e) => {
                try {
                    e.preventDefault();
                    uploadArea.classList.remove('border-primary', 'bg-primary/10');
                    
                    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                        handleFiles(Array.from(e.dataTransfer.files));
                        showConsoleMessage(`已拖放${e.dataTransfer.files.length}张图片`);
                    }
                } catch (error) {
                    console.error('拖放错误:', error);
                    showConsoleMessage('拖放文件时出错');
                }
            });
            
            // 事件监听：质量滑块变化
            qualitySlider.addEventListener('input', () => {
                try {
                    // 对于PNG格式，限制最高质量为70%以确保压缩效果
                    if (selectedFormat === 'png' && qualitySlider.value > 70) {
                        qualitySlider.value = 70;
                        qualityValue.textContent = '70%';
                        alert('PNG格式质量过高会导致文件变大，建议设置在30-70%之间');
                        return;
                    }
                    
                    qualityValue.textContent = `${qualitySlider.value}%`;
                    
                    // 根据质量值自动调整压缩强度标记
                    if (qualitySlider.value < 50) {
                        compressionStrengthBtns.forEach(b => b.classList.remove('format-btn-active'));
                        document.querySelector('[data-strength="high"]').classList.add('format-btn-active');
                        compressionStrength = 'high';
                    } else if (qualitySlider.value < 70) {
                        compressionStrengthBtns.forEach(b => b.classList.remove('format-btn-active'));
                        document.querySelector('[data-strength="medium"]').classList.add('format-btn-active');
                        compressionStrength = 'medium';
                    } else {
                        compressionStrengthBtns.forEach(b => b.classList.remove('format-btn-active'));
                        document.querySelector('[data-strength="low"]').classList.add('format-btn-active');
                        compressionStrength = 'low';
                    }
                    
                    showConsoleMessage(`压缩质量设置为${qualitySlider.value}%`);
                } catch (error) {
                    console.error('质量滑块错误:', error);
                    showConsoleMessage('质量调节时出错');
                }
            });
            
            // 事件监听：尺寸调整滑块变化
            resizePercentage.addEventListener('input', () => {
                try {
                    resizeValue.textContent = `${resizePercentage.value}%`;
                    showConsoleMessage(`图片尺寸设置为${resizePercentage.value}%`);
                } catch (error) {
                    console.error('尺寸滑块错误:', error);
                    showConsoleMessage('尺寸调节时出错');
                }
            });
            
            // 事件监听：全部压缩按钮点击
            compressAllBtn.addEventListener('click', function() {
                try {
                    // 防止重复点击
                    if (isCompressing) {
                        showConsoleMessage('正在压缩中，请稍候...');
                        return;
                    }
                    
                    if (selectedFiles.length === 0) {
                        showConsoleMessage('请先选择图片');
                        return;
                    }
                    
                    showConsoleMessage('开始压缩图片...');
                    compressAllImages();
                } catch (error) {
                    console.error('压缩按钮点击错误:', error);
                    showConsoleMessage('压缩操作启动失败');
                    isCompressing = false;
                }
            });
            
            // 事件监听：清空按钮点击
            clearAllBtn.addEventListener('click', function() {
                try {
                    if (isCompressing) {
                        if (confirm('正在压缩图片，确定要中断并清空吗？')) {
                            clearAllImages();
                            isCompressing = false;
                        }
                        return;
                    }
                    
                    if (confirm('确定要清空所有图片吗？')) {
                        clearAllImages();
                    }
                } catch (error) {
                    console.error('清空按钮错误:', error);
                    showConsoleMessage('清空操作失败');
                }
            });
            
            // 事件监听：下载全部按钮点击
            downloadAllBtn.addEventListener('click', function() {
                try {
                    downloadAllImages();
                } catch (error) {
                    console.error('下载全部错误:', error);
                    showConsoleMessage('下载全部失败');
                }
            });
            
            // 事件监听：下载当前按钮点击
            downloadCurrentBtn.addEventListener('click', function() {
                try {
                    downloadCurrentImage();
                } catch (error) {
                    console.error('下载当前错误:', error);
                    showConsoleMessage('下载当前图片失败');
                }
            });
            
            // 处理上传的文件
            function handleFiles(files) {
                // 过滤非图片文件
                const imageFiles = files.filter(file => file.type.startsWith('image/'));
                
                if (imageFiles.length === 0) {
                    alert('请上传图片文件！');
                    return;
                }
                
                // 添加新文件，避免重复
                imageFiles.forEach(file => {
                    if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                        selectedFiles.push(file);
                        addImagePreview(file);
                    }
                });
                
                // 更新显示
                updateImageCount();
                imagesContainer.classList.remove('hidden');
                compressionSettings.classList.remove('opacity-50', 'pointer-events-none');
                compressAllBtn.disabled = false;
                clearAllBtn.disabled = false;
                
                // 隐藏之前的压缩结果
                resultPreview.classList.add('hidden');
            }
            
            // 添加图片预览
            function addImagePreview(file) {
                const previewItem = document.createElement('div');
                previewItem.className = 'relative group bg-gray-50 rounded-lg overflow-hidden shadow-sm transition-custom hover:shadow';
                previewItem.dataset.index = selectedFiles.length - 1;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    // 创建图片元素
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'w-full h-24 object-cover';
                    img.alt = file.name;
                    
                    // 创建删除按钮
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'absolute top-1 right-1 bg-white/80 hover:bg-white text-red-500 p-1 rounded-full opacity-0 group-hover:opacity-100 transition-custom';
                    deleteBtn.innerHTML = '<i class="fa fa-times"></i>';
                    deleteBtn.title = '删除图片';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeImage(parseInt(previewItem.dataset.index));
                    });
                    
                    // 创建文件信息标签
                    const infoTag = document.createElement('div');
                    infoTag.className = 'absolute bottom-0 left-0 right-0 bg-black/60 text-white text-xs p-1';
                    infoTag.innerHTML = `
                        <div class="truncate">${file.name}</div>
                        <div>${formatFileSize(file.size)}</div>
                    `;
                    
                    // 组装预览项
                    previewItem.appendChild(img);
                    previewItem.appendChild(deleteBtn);
                    previewItem.appendChild(infoTag);
                    originalPreviews.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            }
            
            // 移除图片
            function removeImage(index) {
                // 从数组中移除
                selectedFiles.splice(index, 1);
                compressedFiles = compressedFiles.filter((_, i) => i !== index);
                
                // 重新渲染所有预览
                originalPreviews.innerHTML = '';
                selectedFiles.forEach((file, i) => {
                    addImagePreview(file, i);
                });
                
                // 更新显示
                updateImageCount();
                
                // 如果没有图片了，重置界面
                if (selectedFiles.length === 0) {
                    imagesContainer.classList.add('hidden');
                    compressionSettings.classList.add('opacity-50', 'pointer-events-none');
                    compressAllBtn.disabled = true;
                    clearAllBtn.disabled = true;
                    resultPreview.classList.add('hidden');
                }
            }
            
            // 清空所有图片
            function clearAllImages() {
                selectedFiles = [];
                compressedFiles = [];
                originalPreviews.innerHTML = '';
                updateImageCount();
                imagesContainer.classList.add('hidden');
                compressionSettings.classList.add('opacity-50', 'pointer-events-none');
                compressAllBtn.disabled = true;
                clearAllBtn.disabled = true;
                resultPreview.classList.add('hidden');
                loadingModal.classList.add('hidden');
            }
            
            // 更新图片计数
            function updateImageCount() {
                imageCount.textContent = `${selectedFiles.length}张图片`;
            }
            
            // 智能压缩算法：根据图片类型、大小和压缩强度调整压缩策略
            function getOptimalQuality(file, baseQuality) {
                let quality = baseQuality;
                
                // 根据压缩强度调整
                switch(compressionStrength) {
                    case 'low':
                        quality *= 1.0;
                        break;
                    case 'medium':
                        quality *= 0.8;
                        break;
                    case 'high':
                        quality *= 0.6;
                        break;
                }
                
                // 对于PNG格式，使用更严格的质量控制
                if (selectedFormat === 'png') {
                    // 根据原始文件大小动态调整质量
                    if (file.size > 3 * 1024 * 1024) { // 3MB以上
                        quality = Math.max(20, Math.min(50, quality));
                    } else if (file.size > 1 * 1024 * 1024) { // 1-3MB
                        quality = Math.max(30, Math.min(60, quality));
                    } else { // 1MB以下
                        quality = Math.max(40, Math.min(70, quality));
                    }
                }
                // WebP格式可以使用更低的质量获得更好的效果
                else if (selectedFormat === 'webp') {
                    quality = Math.max(20, quality * 0.8);
                }
                
                // 对于大图片，进一步降低质量
                if (file.size > 5 * 1024 * 1024) { // 5MB以上
                    quality = Math.max(10, quality * 0.7);
                }
                
                return quality;
            }
            
            // 图片尺寸调整
            function getResizedDimensions(width, height) {
                const resizeRatio = parseInt(resizePercentage.value) / 100;
                return {
                    width: Math.round(width * resizeRatio),
                    height: Math.round(height * resizeRatio)
                };
            }
            
            // PNG深度压缩优化
            function optimizePng(ctx, width, height) {
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                // 减少颜色数量（更激进的算法）
                if (pngReduceColors.checked) {
                    const colorLevels = compressionStrength === 'high' ? 8 : 16; // 深度压缩使用更少的颜色级别
                    const step = 256 / colorLevels;
                    
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.floor(data[i] / step) * step;     // R
                        data[i + 1] = Math.floor(data[i + 1] / step) * step; // G
                        data[i + 2] = Math.floor(data[i + 2] / step) * step; // B
                        
                        // 对于深度压缩，进一步简化颜色
                        if (compressionStrength === 'high') {
                            // 颜色阈值化处理
                            if (data[i + 3] < 50) data[i + 3] = 0; // 几乎透明的变为完全透明
                            else if (data[i + 3] < 200) data[i + 3] = 128; // 半透明的变为半透明
                            else data[i + 3] = 255; // 几乎不透明的变为完全不透明
                        }
                    }
                }
                
                // 转为8位PNG（减少颜色深度）
                if (pngConvertTo8bit.checked) {
                    // 简化颜色到256色以内
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.floor(data[i] / 32) * 32;     // 8级红色
                        data[i + 1] = Math.floor(data[i + 1] / 32) * 32; // 8级绿色
                        data[i + 2] = Math.floor(data[i + 2] / 64) * 64; // 4级蓝色
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
            }
            
            // JPEG深度压缩优化
            function optimizeJpeg(ctx, width, height) {
                if (!jpegOptimize.checked) return;
                
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                // 对于深度压缩，应用更多优化
                if (compressionStrength === 'high') {
                    // 降低色彩饱和度
                    for (let i = 0; i < data.length; i += 4) {
                        // 转换为YUV色彩空间以降低饱和度
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        // 简单的去饱和处理
                        const gray = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
                        const saturation = compressionStrength === 'high' ? 0.6 : 0.8; // 深度压缩更低饱和度
                        
                        data[i] = Math.round(gray + (r - gray) * saturation);     // R
                        data[i + 1] = Math.round(gray + (g - gray) * saturation); // G
                        data[i + 2] = Math.round(gray + (b - gray) * saturation); // B
                    }
                }
                
                // 转为灰度图
                if (jpegGrayscale.checked) {
                    for (let i = 0; i < data.length; i += 4) {
                        const gray = Math.round(0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]);
                        data[i] = gray;     // R
                        data[i + 1] = gray; // G
                        data[i + 2] = gray; // B
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
            }
            
            // 压缩所有图片
            function compressAllImages() {
                if (selectedFiles.length === 0) return;
                
                // 设置压缩状态
                isCompressing = true;
                compressAllBtn.disabled = true;
                loadingModal.classList.remove('hidden');
                
                // 重置压缩结果数组
                compressedFiles = [];
                
                // 显示进度条
                currentImageInfo.classList.remove('hidden');
                compressionProgress.classList.remove('hidden');
                progressBar.style.width = '0%';
                progressText.textContent = `0/${selectedFiles.length}`;
                progressPercentage.textContent = '0%';
                
                // 逐个压缩图片
                compressImageInSequence(0);
            }
            
            // 按顺序压缩图片
            function compressImageInSequence(index) {
                // 检查是否已取消压缩
                if (!isCompressing) return;
                
                if (index >= selectedFiles.length) {
                    // 所有图片压缩完成
                    progressBar.style.width = '100%';
                    progressText.textContent = `${selectedFiles.length}/${selectedFiles.length}`;
                    progressPercentage.textContent = '100%';
                    
                    // 显示最后一张图片的压缩结果
                    showCompressedResult(selectedFiles.length - 1);
                    
                    // 重置压缩状态
                    isCompressing = false;
                    compressAllBtn.disabled = false;
                    loadingModal.classList.add('hidden');
                    
                    showConsoleMessage('所有图片压缩完成');
                    return;
                }
                
                // 更新当前处理图片信息
                const file = selectedFiles[index];
                currentImageName.textContent = file.name;
                showConsoleMessage(`正在压缩: ${file.name}`);
                
                // 获取优化后的质量值
                const baseQuality = qualitySlider.value / 100;
                const optimalQuality = getOptimalQuality(file, baseQuality);
                
                const img = new Image();
                
                // 处理跨域问题
                img.crossOrigin = 'anonymous';
                
                img.onload = () => {
                    try {
                        // 获取调整后的尺寸
                        const {width: resizedWidth, height: resizedHeight} = getResizedDimensions(img.width, img.height);
                        
                        // 创建canvas元素
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // 设置canvas尺寸（调整后的尺寸）
                        canvas.width = resizedWidth;
                        canvas.height = resizedHeight;
                        
                        // 对于PNG格式，确保透明背景正确处理
                        if (selectedFormat === 'png') {
                            // 清除画布并设置透明背景
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                        }
                        
                        // 绘制图片到canvas（同时调整尺寸）
                        ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, resizedWidth, resizedHeight);
                        
                        // 应用格式特定的深度优化
                        if (selectedFormat === 'png') {
                            optimizePng(ctx, resizedWidth, resizedHeight);
                        } else if (selectedFormat === 'jpeg') {
                            optimizeJpeg(ctx, resizedWidth, resizedHeight);
                        }
                        
                        // 设置正确的MIME类型
                        const mimeType = selectedFormat === 'jpeg' ? 'image/jpeg' : 
                                         selectedFormat === 'png' ? 'image/png' : 'image/webp';
                        
                        // 处理可能的压缩后文件变大问题
                        const handleCompressedBlob = (blob) => {
                            if (!isCompressing) return; // 检查是否已取消
                            
                            if (!blob) {
                                // 处理生成blob失败的情况
                                errorWarning.classList.remove('hidden');
                                saveCompressedResult(file, null, {width: resizedWidth, height: resizedHeight}, index, true);
                                return;
                            }
                            
                            // 如果压缩后文件仍然变大，尝试更激进的压缩
                            if (blob.size > file.size * 1.05) {
                                showConsoleMessage(`对 ${file.name} 应用深度压缩`);
                                
                                // 尝试更低的质量和/或更小的尺寸
                                const lowerQuality = Math.max(0.1, optimalQuality * 0.5);
                                const smallerResizeRatio = Math.max(0.5, parseInt(resizePercentage.value) / 100 * 0.8);
                                const smallerWidth = Math.round(img.width * smallerResizeRatio);
                                const smallerHeight = Math.round(img.height * smallerResizeRatio);
                                
                                // 创建新的canvas用于二次压缩
                                const smallCanvas = document.createElement('canvas');
                                smallCanvas.width = smallerWidth;
                                smallCanvas.height = smallerHeight;
                                const smallCtx = smallCanvas.getContext('2d');
                                
                                if (selectedFormat === 'png') {
                                    smallCtx.clearRect(0, 0, smallerWidth, smallerHeight);
                                }
                                
                                smallCtx.drawImage(img, 0, 0, img.width, img.height, 0, 0, smallerWidth, smallerHeight);
                                
                                // 应用更激进的优化
                                if (selectedFormat === 'png') {
                                    // 强制启用所有PNG优化选项
                                    pngConvertTo8bit.checked = true;
                                    optimizePng(smallCtx, smallerWidth, smallerHeight);
                                } else if (selectedFormat === 'jpeg') {
                                    // 强制转为灰度图以减小体积
                                    jpegGrayscale.checked = true;
                                    optimizeJpeg(smallCtx, smallerWidth, smallerHeight);
                                }
                                
                                smallCanvas.toBlob((lowerBlob) => {
                                    if (!isCompressing) return;
                                    
                                    if (lowerBlob && lowerBlob.size < blob.size) {
                                        // 使用更低质量和更小尺寸的结果
                                        saveCompressedResult(
                                            file, 
                                            lowerBlob, 
                                            {width: smallerWidth, height: smallerHeight}, 
                                            index
                                        );
                                    } else {
                                        // 如果仍然更大，使用原始压缩结果
                                        saveCompressedResult(file, blob, {width: resizedWidth, height: resizedHeight}, index);
                                    }
                                }, mimeType, lowerQuality);
                            } else {
                                saveCompressedResult(file, blob, {width: resizedWidth, height: resizedHeight}, index);
                            }
                        };
                        
                        // 生成压缩后的图片
                        if (selectedFormat === 'png') {
                            try {
                                const dataUrl = canvas.toDataURL('image/png', optimalQuality);
                                fetch(dataUrl)
                                    .then(res => res.blob())
                                    .then(blob => {
                                        if (isCompressing) {
                                            handleCompressedBlob(blob);
                                        }
                                    })
                                    .catch(err => {
                                        console.error('PNG转换失败:', err);
                                        errorWarning.classList.remove('hidden');
                                        saveCompressedResult(file, null, {width: resizedWidth, height: resizedHeight}, index, true);
                                    });
                            } catch (err) {
                                console.error('PNG处理错误:', err);
                                errorWarning.classList.remove('hidden');
                                saveCompressedResult(file, null, {width: resizedWidth, height: resizedHeight}, index, true);
                            }
                        } else {
                            // JPEG和WebP使用常规toBlob方法
                            canvas.toBlob(handleCompressedBlob, mimeType, optimalQuality);
                        }
                    } catch (error) {
                        console.error('图片处理错误:', error);
                        saveCompressedResult(file, null, {width: 0, height: 0}, index, true);
                    }
                };
                
                // 处理图片加载错误
                img.onerror = () => {
                    console.error(`无法加载图片: ${file.name}`);
                    errorWarning.classList.remove('hidden');
                    // 继续处理下一张图片
                    saveCompressedResult(file, null, {width: 0, height: 0}, index, true);
                };
                
                // 读取图片
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                };
                reader.onerror = () => {
                    console.error(`文件读取错误: ${file.name}`);
                    saveCompressedResult(file, null, {width: 0, height: 0}, index, true);
                };
                reader.readAsDataURL(file);
            }
            
            // 保存压缩结果并继续处理
            function saveCompressedResult(originalFile, blob, dimensions, index, isError = false) {
                if (!isCompressing) return; // 检查是否已取消
                
                if (isError || !blob) {
                    // 处理错误情况
                    compressedFiles.push({
                        originalFile: originalFile,
                        blob: null,
                        width: dimensions.width,
                        height: dimensions.height,
                        url: '',
                        error: true
                    });
                } else {
                    // 保存压缩后的文件信息
                    const url = URL.createObjectURL(blob);
                    compressedFiles.push({
                        originalFile: originalFile,
                        blob: blob,
                        width: dimensions.width,
                        height: dimensions.height,
                        url: url,
                        error: false
                    });
                }
                
                // 更新进度
                const progress = ((index + 1) / selectedFiles.length) * 100;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${index + 1}/${selectedFiles.length}`;
                progressPercentage.textContent = `${Math.round(progress)}%`;
                
                // 处理下一张图片
                compressImageInSequence(index + 1);
            }
            
            // 显示压缩结果
            function showCompressedResult(index) {
                if (index >= compressedFiles.length) return;
                
                const result = compressedFiles[index];
                
                // 重置警告
                sizeWarning.classList.add('hidden');
                errorWarning.classList.add('hidden');
                
                if (result.error) {
                    // 显示错误信息
                    compressedImage.src = '';
                    originalSize.textContent = `原图: ${formatFileSize(result.originalFile.size)}`;
                    compressedSize.textContent = '压缩后: 处理失败';
                    compressedDimensions.textContent = '尺寸: --';
                    savings.textContent = '节省: --';
                    errorWarning.classList.remove('hidden');
                } else {
                    // 更新预览
                    compressedImage.src = result.url;
                    originalSize.textContent = `原图: ${formatFileSize(result.originalFile.size)}`;
                    compressedSize.textContent = `压缩后: ${formatFileSize(result.blob.size)}`;
                    compressedDimensions.textContent = `尺寸: ${result.width} × ${result.height}`;
                    
                    // 计算节省的空间
                    const original = result.originalFile.size;
                    const compressed = result.blob.size;
                    
                    if (compressed < original) {
                        const savingPercent = Math.round((1 - compressed / original) * 100);
                        const savingSize = original - compressed;
                        savings.textContent = `节省: ${savingPercent}% (${formatFileSize(savingSize)})`;
                    } else {
                        const increasePercent = Math.round((compressed / original - 1) * 100);
                        savings.textContent = `增大: ${increasePercent}%`;
                        sizeWarning.classList.remove('hidden');
                    }
                }
                
                // 显示结果区域
                resultPreview.classList.remove('hidden');
            }
            
            // 下载当前图片
            function downloadCurrentImage() {
                if (compressedFiles.length === 0) return;
                
                // 找到当前显示的图片
                const result = compressedFiles[compressedFiles.length - 1];
                if (result.error) {
                    alert('该图片处理出错，无法下载');
                    return;
                }
                
                downloadImage(result, compressedFiles.length - 1);
            }
            
            // 下载所有图片
            function downloadAllImages() {
                if (compressedFiles.length === 0) return;
                
                // 检查是否有处理错误的图片
                const errorFiles = compressedFiles.filter(f => f.error);
                if (errorFiles.length > 0) {
                    if (!confirm(`有${errorFiles.length}张图片处理出错，是否继续下载其他图片？`)) {
                        return;
                    }
                }
                
                // 如果只有一张图片，直接下载
                if (compressedFiles.length === 1) {
                    const result = compressedFiles[0];
                    if (!result.error) downloadImage(result, 0);
                    return;
                }
                
                // 多张图片，逐个下载
                let delay = 0;
                compressedFiles.forEach((result, index) => {
                    if (!result.error) {
                        // 延迟下载，避免浏览器限制
                        setTimeout(() => {
                            downloadImage(result, index);
                        }, delay);
                        delay += 500;
                    }
                });
            }
            
            // 下载单个图片
            function downloadImage(result, index) {
                if (!result.blob) return;
                
                const url = result.url;
                const a = document.createElement('a');
                
                // 设置文件名和格式
                const originalName = result.originalFile.name.split('.').slice(0, -1).join('.');
                const fileName = selectedFiles.length > 1 
                    ? `${originalName}_compressed_${index + 1}.${selectedFormat}`
                    : `${originalName}_compressed.${selectedFormat}`;
                    
                a.download = fileName;
                a.href = url;
                
                // 触发下载
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                showConsoleMessage(`已下载: ${fileName}`);
            }
            
            // 格式化文件大小显示
            function formatFileSize(bytes) {
                if (bytes < 1024) return `${bytes} B`;
                if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
                return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
            }
            
            // 初始化
            pngOptimizationOptions.classList.add('hidden');
            jpegOptimizationOptions.classList.add('hidden');
            updateQualityByStrength();
            showConsoleMessage('工具已准备就绪，支持深度压缩');
        });
    </script>
</body>
</html>
